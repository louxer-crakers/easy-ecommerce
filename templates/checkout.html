{% extends "base.html" %}

{% block title %}Checkout - Cloud Store{% endblock %}

{% block content %}
<div class="container">
    <div class="checkout-container">
        <h1 class="page-title">Checkout</h1>

        <div class="checkout-content">
            <div class="checkout-form">
                <form id="checkout-form">
                    <div class="form-section">
                        <h3>Shipping Information</h3>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="shipping-name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="shipping-phone" required>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="shipping-address" rows="3" required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="shipping-city" required>
                            </div>
                            <div class="form-group">
                                <label>Postal Code</label>
                                <input type="text" id="shipping-postal" required>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-check"></i> Place Order
                    </button>
                </form>
            </div>

            <div class="order-summary-sidebar">
                <h3>Order Summary</h3>
                <div id="order-items"></div>
                <div class="summary-totals">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="checkout-subtotal">Rp 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (11%)</span>
                        <span id="checkout-tax">Rp 0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="checkout-total">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let totals = {};

    document.addEventListener('DOMContentLoaded', () => {
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            sessionStorage.setItem('returnUrl', '/checkout');
            window.location.href = '/auth';
            return;
        }

        loadCartForCheckout();
        populateShippingInfo();
    });

    function loadCartForCheckout() {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');

        if (cart.length === 0) {
            showToast('Your cart is empty', 'error');
            setTimeout(() => window.location.href = '/cart', 1500);
            return;
        }

        displayOrderItems();
        calculateTotals();
    }

    function displayOrderItems() {
        const container = document.getElementById('order-items');

        container.innerHTML = cart.map(item => `
        <div class="order-item">
            <span>${item.name} x ${item.quantity}</span>
            <span>${formatCurrency(item.price * item.quantity)}</span>
        </div>
    `).join('');
    }

    function calculateTotals() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = subtotal * 0.11;
        const total = subtotal + tax;

        totals = { subtotal, tax, total };

        document.getElementById('checkout-subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('checkout-tax').textContent = formatCurrency(tax);
        document.getElementById('checkout-total').textContent = formatCurrency(total);
    }

    async function populateShippingInfo() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.name) {
            document.getElementById('shipping-name').value = user.name;
        }

        // Load user profile to autofill saved address
        try {
            const response = await authenticatedFetch('/api/auth/verify');
            const data = await response.json();

            if (data.success && data.user) {
                const profile = data.user;
                if (profile.phone) document.getElementById('shipping-phone').value = profile.phone;
                if (profile.address_street) document.getElementById('shipping-address').value = profile.address_street;
                if (profile.address_city) document.getElementById('shipping-city').value = profile.address_city;
                if (profile.address_postal_code) document.getElementById('shipping-postal').value = profile.address_postal_code;
            }
        } catch (error) {
            console.log('Could not load saved address:', error);
        }
    }

    document.getElementById('checkout-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const token = localStorage.getItem('token');

        const shippingAddress = {
            name: document.getElementById('shipping-name').value,
            phone: document.getElementById('shipping-phone').value,
            address: document.getElementById('shipping-address').value,
            city: document.getElementById('shipping-city').value,
            postal_code: document.getElementById('shipping-postal').value
        };

        const orderData = {
            items: cart,
            total_amount: totals.total,
            shipping_address: shippingAddress
        };

        try {
            // Save address to profile (optional, in background)
            try {
                await authenticatedFetch('/api/user/address', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: shippingAddress.phone,
                        address_street: shippingAddress.address,
                        address_city: shippingAddress.city,
                        address_state: '-',
                        address_postal_code: shippingAddress.postal_code
                    })
                });
            } catch (e) {
                console.log('Address not saved to profile');
            }

            // Place order  
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(orderData)
            });

            const data = await response.json();

            if (data.success) {
                // Clear cart
                localStorage.removeItem('cart');
                updateCartCount();

                showToast('Order placed successfully!', 'success');
                setTimeout(() => window.location.href = '/orders', 2000);
            } else {
                showToast(data.error || 'Failed to place order', 'error');
            }
        } catch (error) {
            console.error('Checkout error:', error);
            showToast('Failed to place order', 'error');
        }
    });
</script>
{% endblock %}